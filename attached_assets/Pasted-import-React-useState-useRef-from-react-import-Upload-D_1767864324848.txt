import React, { useState, useRef } from ‘react’;
import { Upload, Download, Play, Pause, Settings, Zap } from ‘lucide-react’;

const AudioMasteringApp = () => {
const [audioFile, setAudioFile] = useState(null);
const [originalAudio, setOriginalAudio] = useState(null);
const [processedAudios, setProcessedAudios] = useState({});
const [selectedPreset, setSelectedPreset] = useState(‘balanced’);
const [isProcessing, setIsProcessing] = useState(false);
const [isPlaying, setIsPlaying] = useState(false);
const [currentTime, setCurrentTime] = useState(0);
const [duration, setDuration] = useState(0);

const audioContextRef = useRef(null);
const sourceNodeRef = useRef(null);

const presets = {
balanced: {
name: “Balanced Trap”,
description: “Clean, professional mix with balanced frequencies. Perfect for vocal-focused tracks.”,
settings: {
bassBoost: 4,
midClarity: 3,
highShine: 2,
compression: 3,
stereoWidth: 2.5,
loudness: -8
}
},
heavy: {
name: “Heavy 808s”,
description: “Maximum bass impact with aggressive compression. For hard-hitting trap bangers.”,
settings: {
bassBoost: 6,
midClarity: 2,
highShine: 3,
compression: 5,
stereoWidth: 2,
loudness: -7
}
},
vocal: {
name: “Vocal Focus”,
description: “Enhanced vocal presence and clarity. Keeps your lyrics front and center.”,
settings: {
bassBoost: 3,
midClarity: 5,
highShine: 4,
compression: 2.5,
stereoWidth: 3,
loudness: -9
}
},
modern: {
name: “Modern Trap”,
description: “Contemporary streaming-ready sound with wide stereo image and punchy dynamics.”,
settings: {
bassBoost: 5,
midClarity: 4,
highShine: 3.5,
compression: 4,
stereoWidth: 3.5,
loudness: -8.5
}
}
};

const isIOS = () =>
/iPad|iPhone|iPod/.test(navigator.userAgent) ||
(navigator.platform === “MacIntel” && navigator.maxTouchPoints > 1);

const safeFilename = (name) =>
name.replace(/[^\w-.]+/g, “*”).replace(/*+/g, “_”).slice(0, 120);

const handleFileUpload = async (event) => {
const file = event.target.files[0];
if (file && file.type.startsWith(‘audio/’)) {
setAudioFile(file);
setIsProcessing(true);

```
  const arrayBuffer = await file.arrayBuffer();
  
  if (!audioContextRef.current) {
    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  const audioBuffer = await audioContextRef.current.decodeAudioData(arrayBuffer);
  setOriginalAudio(audioBuffer);
  setDuration(audioBuffer.duration);
  
  const processed = {};
  for (const presetKey in presets) {
    processed[presetKey] = await processAudio(audioBuffer, presets[presetKey].settings);
  }
  
  setProcessedAudios(processed);
  setIsProcessing(false);
}
```

};

const processAudio = async (audioBuffer, settings) => {
const ctx = audioContextRef.current;
const offlineCtx = new OfflineAudioContext(
audioBuffer.numberOfChannels,
audioBuffer.length,
audioBuffer.sampleRate
);

```
const source = offlineCtx.createBufferSource();
source.buffer = audioBuffer;

// Low shelf for bass boost (20-250 Hz)
const bassFilter = offlineCtx.createBiquadFilter();
bassFilter.type = 'lowshelf';
bassFilter.frequency.value = 100;
bassFilter.gain.value = settings.bassBoost;

// Peaking filter for mid clarity (400-2000 Hz)
const midFilter = offlineCtx.createBiquadFilter();
midFilter.type = 'peaking';
midFilter.frequency.value = 1000;
midFilter.Q.value = 0.7;
midFilter.gain.value = settings.midClarity;

// High shelf for presence and air (4000+ Hz)
const highFilter = offlineCtx.createBiquadFilter();
highFilter.type = 'highshelf';
highFilter.frequency.value = 4000;
highFilter.gain.value = settings.highShine;

// Dynamics compression
const compressor = offlineCtx.createDynamicsCompressor();
compressor.threshold.value = -24;
compressor.knee.value = 30;
compressor.ratio.value = 4 + (settings.compression * 2);
compressor.attack.value = 0.003;
compressor.release.value = 0.25;

// Stereo widening with mid-side processing simulation
const splitter = offlineCtx.createChannelSplitter(2);
const merger = offlineCtx.createChannelMerger(2);

const leftGain = offlineCtx.createGain();
const rightGain = offlineCtx.createGain();

const widthFactor = 1 + (settings.stereoWidth * 0.15);
leftGain.gain.value = widthFactor;
rightGain.gain.value = widthFactor;

// Final limiter for loudness
const limiter = offlineCtx.createDynamicsCompressor();
limiter.threshold.value = settings.loudness;
limiter.knee.value = 0;
limiter.ratio.value = 20;
limiter.attack.value = 0.001;
limiter.release.value = 0.1;

// Makeup gain
const makeupGain = offlineCtx.createGain();
makeupGain.gain.value = Math.pow(10, Math.abs(settings.loudness) / 20) * 0.95;

// Connect the processing chain
source.connect(bassFilter);
bassFilter.connect(midFilter);
midFilter.connect(highFilter);
highFilter.connect(compressor);

if (audioBuffer.numberOfChannels === 2) {
  compressor.connect(splitter);
  splitter.connect(leftGain, 0);
  splitter.connect(rightGain, 1);
  leftGain.connect(merger, 0, 0);
  rightGain.connect(merger, 0, 1);
  merger.connect(limiter);
} else {
  compressor.connect(limiter);
}

limiter.connect(makeupGain);
makeupGain.connect(offlineCtx.destination);

source.start(0);
const renderedBuffer = await offlineCtx.startRendering();

return renderedBuffer;
```

};

const playAudio = () => {
if (!processedAudios[selectedPreset]) return;

```
if (isPlaying) {
  if (sourceNodeRef.current) {
    sourceNodeRef.current.stop();
    sourceNodeRef.current = null;
  }
  setIsPlaying(false);
  return;
}

const source = audioContextRef.current.createBufferSource();
source.buffer = processedAudios[selectedPreset];
source.connect(audioContextRef.current.destination);

const startTime = audioContextRef.current.currentTime;
source.start(0, currentTime);

sourceNodeRef.current = source;
setIsPlaying(true);

source.onended = () => {
  setIsPlaying(false);
  setCurrentTime(0);
  sourceNodeRef.current = null;
};

const updateTime = () => {
  if (sourceNodeRef.current) {
    const elapsed = audioContextRef.current.currentTime - startTime + currentTime;
    setCurrentTime(Math.min(elapsed, duration));
    if (elapsed < duration) {
      requestAnimationFrame(updateTime);
    }
  }
};
updateTime();
```

};

const bufferToWav = (buffer) => {
const numberOfChannels = buffer.numberOfChannels;
const length = buffer.length * numberOfChannels * 2;
const arrayBuffer = new ArrayBuffer(44 + length);
const view = new DataView(arrayBuffer);

```
const writeString = (offset, string) => {
  for (let i = 0; i < string.length; i++) {
    view.setUint8(offset + i, string.charCodeAt(i));
  }
};

writeString(0, 'RIFF');
view.setUint32(4, 36 + length, true);
writeString(8, 'WAVE');
writeString(12, 'fmt ');
view.setUint32(16, 16, true);
view.setUint16(20, 1, true);
view.setUint16(22, numberOfChannels, true);
view.setUint32(24, buffer.sampleRate, true);
view.setUint32(28, buffer.sampleRate * numberOfChannels * 2, true);
view.setUint16(32, numberOfChannels * 2, true);
view.setUint16(34, 16, true);
writeString(36, 'data');
view.setUint32(40, length, true);

let offset = 44;
for (let i = 0; i < buffer.length; i++) {
  for (let channel = 0; channel < numberOfChannels; channel++) {
    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
    offset += 2;
  }
}

return new Blob([arrayBuffer], { type: 'audio/wav' });
```

};

const exportAudio = async () => {
if (!processedAudios[selectedPreset] || !audioFile) return;

```
const buffer = processedAudios[selectedPreset];

const blob = bufferToWav(buffer);
const filename = safeFilename(
  `mastered_${presets[selectedPreset].name.replace(/\s+/g, "_")}_${audioFile.name.replace(/\.[^/.]+$/, "")}.wav`
);

// Try native Share Sheet first (if supported)
try {
  const file = new File([blob], filename, { type: "audio/wav" });
  if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
    await navigator.share({ files: [file], title: filename, text: "Mastered Track" });
    return;
  }
} catch (_) {}

// iOS fallback: SAME TAB navigation to blob URL (most reliable)
const url = URL.createObjectURL(blob);

if (isIOS()) {
  window.location.assign(url);
  setTimeout(() => URL.revokeObjectURL(url), 5 * 60 * 1000); // 5 minutes
  return;
}

// Desktop fallback: normal download
const a = document.createElement("a");
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
a.remove();
setTimeout(() => URL.revokeObjectURL(url), 30 * 1000);
```

};

const formatTime = (seconds) => {
const mins = Math.floor(seconds / 60);
const secs = Math.floor(seconds % 60);
return `${mins}:${secs.toString().padStart(2, '0')}`;
};

return (
<div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 p-8">
<div className="max-w-4xl mx-auto">
<div className="text-center mb-8">
<div className="flex items-center justify-center gap-3 mb-4">
<Zap className="w-10 h-10 text-purple-400" />
<h1 className="text-4xl font-bold text-white">Trap Master Pro</h1>
</div>
<p className="text-purple-200 text-lg">Professional-grade mastering for your trap freestyles</p>
</div>

```
    {!audioFile ? (
      <div className="bg-gray-800 rounded-lg p-12 border-2 border-dashed border-purple-500">
        <label className="flex flex-col items-center cursor-pointer">
          <Upload className="w-16 h-16 text-purple-400 mb-4" />
          <span className="text-xl text-white mb-2">Upload Your Track</span>
          <span className="text-purple-300 text-sm">Supports MP3, WAV, M4A, and more</span>
          <input
            type="file"
            accept="audio/*,.mp3,.wav,.m4a,.aac,.ogg,.flac,.wma,.aiff,.opus"
            onChange={handleFileUpload}
            className="hidden"
          />
        </label>
      </div>
    ) : (
      <div className="space-y-6">
        <div className="bg-gray-800 rounded-lg p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h3 className="text-white font-semibold text-lg">{audioFile.name}</h3>
              <p className="text-purple-300 text-sm">{formatTime(duration)} duration</p>
            </div>
            <label className="cursor-pointer">
              <div className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                <Upload className="w-4 h-4" />
                Change File
              </div>
              <input
                type="file"
                accept="audio/*,.mp3,.wav,.m4a,.aac,.ogg,.flac,.wma,.aiff,.opus"
                onChange={handleFileUpload}
                className="hidden"
              />
            </label>
          </div>

          {isProcessing ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4"></div>
              <p className="text-purple-300">Processing your track with professional mastering...</p>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                {Object.entries(presets).map(([key, preset]) => (
                  <button
                    key={key}
                    onClick={() => {
                      setSelectedPreset(key);
                      setIsPlaying(false);
                      if (sourceNodeRef.current) {
                        sourceNodeRef.current.stop();
                        sourceNodeRef.current = null;
                      }
                      setCurrentTime(0);
                    }}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      selectedPreset === key
                        ? 'border-purple-500 bg-purple-900/30'
                        : 'border-gray-700 bg-gray-700/30 hover:border-purple-700'
                    }`}
                  >
                    <h4 className="text-white font-semibold mb-1">{preset.name}</h4>
                    <p className="text-purple-300 text-sm">{preset.description}</p>
                  </button>
                ))}
              </div>

              <div className="mb-6">
                <div className="flex items-center gap-4 mb-2">
                  <button
                    onClick={playAudio}
                    className="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-full"
                  >
                    {isPlaying ? <Pause className="w-6 h-6" /> : <Play className="w-6 h-6" />}
                  </button>
                  <div className="flex-1">
                    <div className="bg-gray-700 h-2 rounded-full overflow-hidden">
                      <div
                        className="bg-purple-500 h-full transition-all"
                        style={{ width: `${(currentTime / duration) * 100}%` }}
                      ></div>
                    </div>
                    <div className="flex justify-between text-purple-300 text-sm mt-1">
                      <span>{formatTime(currentTime)}</span>
                      <span>{formatTime(duration)}</span>
                    </div>
                  </div>
                </div>
              </div>

              <button
                onClick={exportAudio}
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-4 rounded-lg flex items-center justify-center gap-2 font-semibold text-lg"
              >
                <Download className="w-5 h-5" />
                Download Mastered Track
              </button>
            </>
          )}
        </div>

        {!isProcessing && (
          <div className="bg-gray-800 rounded-lg p-6">
            <h3 className="text-white font-semibold mb-3 flex items-center gap-2">
              <Settings className="w-5 h-5" />
              Current Preset: {presets[selectedPreset].name}
            </h3>
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div>
                <span className="text-purple-300">Bass Boost:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${(presets[selectedPreset].settings.bassBoost / 6) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <span className="text-purple-300">Mid Clarity:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${(presets[selectedPreset].settings.midClarity / 5) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <span className="text-purple-300">High Shine:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${(presets[selectedPreset].settings.highShine / 4) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <span className="text-purple-300">Compression:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${(presets[selectedPreset].settings.compression / 5) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <span className="text-purple-300">Stereo Width:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${(presets[selectedPreset].settings.stereoWidth / 4) * 100}%` }}
                  ></div>
                </div>
              </div>
              <div>
                <span className="text-purple-300">Loudness:</span>
                <div className="bg-gray-700 h-2 rounded-full mt-1">
                  <div
                    className="bg-purple-500 h-full rounded-full"
                    style={{ width: `${((Math.abs(presets[selectedPreset].settings.loudness) - 7) / 2) * 100}%` }}
                  ></div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    )}
  </div>
</div>
```

);
};

export default AudioMasteringApp;